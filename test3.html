<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Data Manager</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
    <div class="container">
        <h1>User Data Manager</h1>

        <div id="auth-section">
            <h2>Sign in with Google</h2>
            <div id="g_id_onload"
                 data-client_id="YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"
                 data-callback="handleCredentialResponse"
                 data-auto_select="false"
                 data-cancel_on_tap_outside="false">
            </div>
            <div class="g_id_signin"
                 data-type="standard"
                 data-size="large"
                 data-theme="outline"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
            <button id="signOutButton" class="button" style="display: none;">Sign Out</button>
        </div>

        <div id="app-section" style="display: none;">
            <p>Welcome, <span id="userName"></span>!</p>
            <p>Your Google ID: <span id="userGoogleId"></span></p>

            <div class="section">
                <h2>Main Category Data</h2>
                <form id="categoryForm">
                    <label>Checkbox 1: <input type="checkbox" id="catCheckbox1"></label><br>
                    <label>Checkbox 2: <input type="checkbox" id="catCheckbox2"></label><br>
                    <label>Checkbox 3: <input type="checkbox" id="catCheckbox3"></label><br>
                    <label>Checkbox 4: <input type="checkbox" id="catCheckbox4"></label><br>
                    <label>Dropdown 1:
                        <select id="catDropdown1">
                            <option value="optionA">Option A</option>
                            <option value="optionB">Option B</option>
                            <option value="optionC">Option C</option>
                        </select>
                    </label><br>
                    <label>Dropdown 2:
                        <select id="catDropdown2">
                            <option value="valueX">Value X</option>
                            <option value="valueY">Value Y</option>
                        </select>
                    </label><br>
                    <label>Dropdown 3:
                        <select id="catDropdown3">
                            <option value="foo">Foo</option>
                            <option value="bar">Bar</option>
                        </select>
                    </label><br>
                    <label>Text Input 1: <input type="text" id="catTextInput1"></label><br>
                    <label>Text Input 2: <input type="text" id="catTextInput2"></label><br>
                    <button type="submit" class="button">Save Category</button>
                    <button type="button" id="deleteCategoryButton" class="button delete-button">Delete Category</button>
                </form>
            </div>

            <div class="section">
                <h2>Subcategories</h2>
                <form id="newSubcategoryForm">
                    <h3>Add New Subcategory</h3>
                    <label>Name: <input type="text" id="subName" required></label><br>
                    <label>Checkbox 1: <input type="checkbox" id="subCheckbox1"></label><br>
                    <label>Checkbox 2: <input type="checkbox" id="subCheckbox2"></label><br>
                    <label>Checkbox 3: <input type="checkbox" id="subCheckbox3"></label><br>
                    <label>Checkbox 4: <input type="checkbox" id="subCheckbox4"></label><br>
                    <label>Dropdown 1:
                        <select id="subDropdown1">
                            <option value="optionA">Option A</option>
                            <option value="optionB">Option B</option>
                            <option value="optionC">Option C</option>
                        </select>
                    </label><br>
                    <label>Dropdown 2:
                        <select id="subDropdown2">
                            <option value="valueX">Value X</option>
                            <option value="valueY">Value Y</option>
                        </select>
                    </label><br>
                    <label>Dropdown 3:
                        <select id="subDropdown3">
                            <option value="foo">Foo</option>
                            <option value="bar">Bar</option>
                        </select>
                    </label><br>
                    <label>Text Input 1: <input type="text" id="subTextInput1"></label><br>
                    <label>Text Input 2: <input type="text" id="subTextInput2"></label><br>
                    <button type="submit" class="button">Add Subcategory</button>
                </form>

                <h3>Existing Subcategories</h3>
                <div id="subcategoriesList">
                    <p>No subcategories found.</p>
                </div>
            </div>
        </div>

        <div id="message" class="message"></div>
    </div>

    <script>
        const CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID.apps.googleusercontent.com"; // **ZAMENI SA TVOJIM CLIENT ID-JEM**
        const BACKEND_URL = "https://botanica.ngrok.app"; // IZMENJENO OVDJE
        let googleToken = null;
        let googleId = null;
        let userName = null;

        const authSection = document.getElementById('auth-section');
        const appSection = document.getElementById('app-section');
        const userNameSpan = document.getElementById('userName');
        const userGoogleIdSpan = document.getElementById('userGoogleId');
        const signOutButton = document.getElementById('signOutButton');
        const messageDiv = document.getElementById('message');
        const categoryForm = document.getElementById('categoryForm');
        const newSubcategoryForm = document.getElementById('newSubcategoryForm');
        const subcategoriesList = document.getElementById('subcategoriesList');
        const deleteCategoryButton = document.getElementById('deleteCategoryButton');

        function showMessage(msg, type = 'info') {
            messageDiv.textContent = msg;
            messageDiv.className = `message ${type}`;
            setTimeout(() => messageDiv.textContent = '', 5000); // Clear after 5 seconds
        }

        async function handleCredentialResponse(response) {
            googleToken = response.credential;
            try {
                const res = await fetch(`https://oauth2.googleapis.com/tokeninfo?id_token=${googleToken}`);
                const data = await res.json();
                googleId = data.sub;
                userName = data.name;

                document.getElementById('g_id_signin').style.display = 'none';
                signOutButton.style.display = 'block';
                authSection.style.display = 'none';
                appSection.style.display = 'block';

                userNameSpan.textContent = userName;
                userGoogleIdSpan.textContent = googleId;

                fetchCategoryData();
                fetchSubcategories();

            } catch (error) {
                console.error("Error verifying token:", error);
                showMessage("Error signing in. Please try again.", "error");
                googleToken = null;
                googleId = null;
            }
        }

        function signOut() {
            googleToken = null;
            googleId = null;
            userName = null;
            document.getElementById('g_id_signin').style.display = 'block';
            signOutButton.style.display = 'none';
            authSection.style.display = 'block';
            appSection.style.display = 'none';
            categoryForm.reset();
            subcategoriesList.innerHTML = '<p>No subcategories found.</p>';
            showMessage("Signed out successfully.");
        }

        signOutButton.addEventListener('click', signOut);

        async function authenticatedFetch(url, options = {}) {
            if (!googleToken) {
                showMessage("Please sign in first.", "error");
                signOut();
                return null;
            }

            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${googleToken}`,
                ...options.headers
            };

            try {
                const response = await fetch(`${BACKEND_URL}${url}`, { ...options, headers });
                if (response.status === 401) {
                    showMessage("Session expired or invalid token. Please sign in again.", "error");
                    signOut();
                    return null;
                }
                return response;
            } catch (error) {
                console.error("Network or server error:", error);
                showMessage("Could not connect to the server. Check if the ngrok tunnel is active and correctly configured.", "error");
                return null;
            }
        }

        // --- Category Management ---
        async function fetchCategoryData() {
            const response = await authenticatedFetch('/categories');
            if (response && response.ok) {
                const data = await response.json();
                document.getElementById('catCheckbox1').checked = data.checkbox1 === 1;
                document.getElementById('catCheckbox2').checked = data.checkbox2 === 1;
                document.getElementById('catCheckbox3').checked = data.checkbox3 === 1;
                document.getElementById('catCheckbox4').checked = data.checkbox4 === 1;
                document.getElementById('catDropdown1').value = data.dropdown1;
                document.getElementById('catDropdown2').value = data.dropdown2;
                document.getElementById('catDropdown3').value = data.dropdown3;
                document.getElementById('catTextInput1').value = data.text_input1;
                document.getElementById('catTextInput2').value = data.text_input2;
                showMessage("Category data loaded.", "success");
            } else if (response && response.status === 404) {
                showMessage("No main category found for you. Fill the form and save to create one.", "info");
                categoryForm.reset(); // Clear form if no existing category
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error fetching category: ${errorData.error || response.statusText}`, "error");
            }
        }

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                checkbox1: document.getElementById('catCheckbox1').checked ? 1 : 0,
                checkbox2: document.getElementById('catCheckbox2').checked ? 1 : 0,
                checkbox3: document.getElementById('catCheckbox3').checked ? 1 : 0,
                checkbox4: document.getElementById('catCheckbox4').checked ? 1 : 0,
                dropdown1: document.getElementById('catDropdown1').value,
                dropdown2: document.getElementById('catDropdown2').value,
                dropdown3: document.getElementById('catDropdown3').value,
                text_input1: document.getElementById('catTextInput1').value,
                text_input2: document.getElementById('catTextInput2').value,
            };

            let response = await authenticatedFetch('/categories', {
                method: 'PUT',
                body: JSON.stringify(data)
            });

            if (response && response.status === 404) { // Category not found, try POST to create
                response = await authenticatedFetch('/categories', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            if (response && response.ok) {
                const result = await response.json();
                showMessage(result.message, "success");
                fetchCategoryData(); // Reload to ensure data is fresh
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error saving category: ${errorData.error || response.statusText}`, "error");
            }
        });

        deleteCategoryButton.addEventListener('click', async () => {
            if (!confirm("Are you sure you want to delete your main category and ALL associated subcategories? This cannot be undone.")) {
                return;
            }
            const response = await authenticatedFetch('/categories', {
                method: 'DELETE'
            });
            if (response && response.ok) {
                const result = await response.json();
                showMessage(result.message, "success");
                categoryForm.reset();
                subcategoriesList.innerHTML = '<p>No subcategories found.</p>';
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error deleting category: ${errorData.error || response.statusText}`, "error");
            }
        });


        // --- Subcategory Management ---
        async function fetchSubcategories() {
            const response = await authenticatedFetch('/subcategories');
            if (response && response.ok) {
                const subcategories = await response.json();
                renderSubcategories(subcategories);
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error fetching subcategories: ${errorData.error || response.statusText}`, "error");
                subcategoriesList.innerHTML = '<p>Error loading subcategories.</p>';
            }
        }

        function renderSubcategories(subcategories) {
            subcategoriesList.innerHTML = '';
            if (subcategories.length === 0) {
                subcategoriesList.innerHTML = '<p>No subcategories found.</p>';
                return;
            }

            subcategories.forEach(sub => {
                const subDiv = document.createElement('div');
                subDiv.className = 'subcategory-item';
                subDiv.innerHTML = `
                    <h3>Subcategory: ${sub.name} (ID: ${sub.id})</h3>
                    <form data-sub-id="${sub.id}" class="subcategory-form">
                        <label>Name: <input type="text" value="${sub.name}" data-field="name" required></label><br>
                        <label>Checkbox 1: <input type="checkbox" ${sub.checkbox1 === 1 ? 'checked' : ''} data-field="checkbox1"></label><br>
                        <label>Checkbox 2: <input type="checkbox" ${sub.checkbox2 === 1 ? 'checked' : ''} data-field="checkbox2"></label><br>
                        <label>Checkbox 3: <input type="checkbox" ${sub.checkbox3 === 1 ? 'checked' : ''} data-field="checkbox3"></label><br>
                        <label>Checkbox 4: <input type="checkbox" ${sub.checkbox4 === 1 ? 'checked' : ''} data-field="checkbox4"></label><br>
                        <label>Dropdown 1:
                            <select data-field="dropdown1">
                                <option value="optionA" ${sub.dropdown1 === 'optionA' ? 'selected' : ''}>Option A</option>
                                <option value="optionB" ${sub.dropdown1 === 'optionB' ? 'selected' : ''}>Option B</option>
                                <option value="optionC" ${sub.dropdown1 === 'optionC' ? 'selected' : ''}>Option C</option>
                            </select>
                        </label><br>
                        <label>Dropdown 2:
                            <select data-field="dropdown2">
                                <option value="valueX" ${sub.dropdown2 === 'valueX' ? 'selected' : ''}>Value X</option>
                                <option value="valueY" ${sub.dropdown2 === 'valueY' ? 'selected' : ''}>Value Y</option>
                            </select>
                        </label><br>
                        <label>Dropdown 3:
                            <select data-field="dropdown3">
                                <option value="foo" ${sub.dropdown3 === 'foo' ? 'selected' : ''}>Foo</option>
                                <option value="bar" ${sub.dropdown3 === 'bar' ? 'selected' : ''}>Bar</option>
                            </select>
                        </label><br>
                        <label>Text Input 1: <input type="text" value="${sub.text_input1}" data-field="text_input1"></label><br>
                        <label>Text Input 2: <input type="text" value="${sub.text_input2}" data-field="text_input2"></label><br>
                        <button type="submit" class="button">Update</button>
                        <button type="button" class="button delete-button" onclick="deleteSubcategory(${sub.id})">Delete</button>
                    </form>
                `;
                subcategoriesList.appendChild(subDiv);
            });

            // Add event listeners for update forms
            document.querySelectorAll('.subcategory-form').forEach(form => {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const subId = form.dataset.subId;
                    const data = {
                        name: form.querySelector('[data-field="name"]').value,
                        checkbox1: form.querySelector('[data-field="checkbox1"]').checked ? 1 : 0,
                        checkbox2: form.querySelector('[data-field="checkbox2"]').checked ? 1 : 0,
                        checkbox3: form.querySelector('[data-field="checkbox3"]').checked ? 1 : 0,
                        checkbox4: form.querySelector('[data-field="checkbox4"]').checked ? 1 : 0,
                        dropdown1: form.querySelector('[data-field="dropdown1"]').value,
                        dropdown2: form.querySelector('[data-field="dropdown2"]').value,
                        dropdown3: form.querySelector('[data-field="dropdown3"]').value,
                        text_input1: form.querySelector('[data-field="text_input1"]').value,
                        text_input2: form.querySelector('[data-field="text_input2"]').value,
                    };

                    const response = await authenticatedFetch(`/subcategories/${subId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });

                    if (response && response.ok) {
                        const result = await response.json();
                        showMessage(result.message, "success");
                        fetchSubcategories(); // Reload to show updated data
                    } else if (response) {
                        const errorData = await response.json();
                        showMessage(`Error updating subcategory: ${errorData.error || response.statusText}`, "error");
                    }
                });
            });
        }

        newSubcategoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                name: document.getElementById('subName').value,
                checkbox1: document.getElementById('subCheckbox1').checked ? 1 : 0,
                checkbox2: document.getElementById('subCheckbox2').checked ? 1 : 0,
                checkbox3: document.getElementById('subCheckbox3').checked ? 1 : 0,
                checkbox4: document.getElementById('subCheckbox4').checked ? 1 : 0,
                dropdown1: document.getElementById('subDropdown1').value,
                dropdown2: document.getElementById('subDropdown2').value,
                dropdown3: document.getElementById('subDropdown3').value,
                text_input1: document.getElementById('subTextInput1').value,
                text_input2: document.getElementById('subTextInput2').value,
            };

            const response = await authenticatedFetch('/subcategories', {
                method: 'POST',
                body: JSON.stringify(data)
            });

            if (response && response.ok) {
                const result = await response.json();
                showMessage(result.message, "success");
                newSubcategoryForm.reset();
                fetchSubcategories(); // Refresh list
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error adding subcategory: ${errorData.error || response.statusText}`, "error");
            }
        });

        async function deleteSubcategory(subId) {
            if (!confirm(`Are you sure you want to delete subcategory ID: ${subId}?`)) {
                return;
            }
            const response = await authenticatedFetch(`/subcategories/${subId}`, {
                method: 'DELETE'
            });

            if (response && response.ok) {
                const result = await response.json();
                showMessage(result.message, "success");
                fetchSubcategories(); // Refresh list
            } else if (response) {
                const errorData = await response.json();
                showMessage(`Error deleting subcategory: ${errorData.error || response.statusText}`, "error");
            }
        }
    </script>
</body>
</html>
