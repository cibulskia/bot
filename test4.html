<!DOCTYPE html>
<html lang="sr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kategorije & Podkategorije - Demo</title>
  <meta http-equiv="Referrer-Policy" content="no-referrer-when-downgrade">
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#f5f7fb; margin:0; padding:20px; }
    .container { max-width:1000px; margin:0 auto; background:white; padding:20px; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    h1 { margin-top:0; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .col { flex:1; min-width:160px; }
    input[type="text"], select, textarea { width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7de; }
    button { padding:10px 14px; border-radius:8px; border:none; background:#0366d6; color:white; cursor:pointer; margin-right:8px; }
    button.secondary { background:#6c757d; }
    .small { font-size:13px; color:#444; margin-top:6px; }
    #subList { width:100%; padding:8px; border-radius:6px; border:1px solid #d0d7de; }
    .controls { margin-top:12px; }
    .panel { background:#fbfdff; padding:12px; border-radius:8px; margin-top:12px; border:1px solid #eef3fb; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Kategorija i podkategorije</h1>
    <div id="g_id_onload"
         data-client_id="252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_select="true"
         data-ux_mode="popup">
    </div>

    <p id="loginStatus" class="small">Čekam Google prijavu...</p>

    <div class="panel">
      <h2>Glavna kategorija (1 kategorija po Google ID)</h2>
      <div class="row">
        <div class="col">
          <label>Checkbox 1</label>
          <input type="checkbox" id="cat_cb1">
        </div>
        <div class="col">
          <label>Checkbox 2</label>
          <input type="checkbox" id="cat_cb2">
        </div>
        <div class="col">
          <label>Checkbox 3</label>
          <input type="checkbox" id="cat_cb3">
        </div>
        <div class="col">
          <label>Checkbox 4</label>
          <input type="checkbox" id="cat_cb4">
        </div>
      </div>

      <label>Dropdown</label>
      <select id="cat_dropdown">
        <option value="">-- izaberite --</option>
        <option value="opcija1">Opcija 1</option>
        <option value="opcija2">Opcija 2</option>
        <option value="opcija3">Opcija 3</option>
      </select>

      <label>Tekstualni unosi</label>
      <input type="text" id="cat_text1" placeholder="Text 1">
      <input type="text" id="cat_text2" placeholder="Text 2">
      <input type="text" id="cat_text3" placeholder="Text 3">
      <input type="text" id="cat_text4" placeholder="Text 4">

      <div class="controls">
        <button id="btnLoadCategory">Učitaj kategoriju</button>
        <button id="btnUpdateCategory">Ažuriraj / Sačuvaj kategoriju</button>
        <button id="btnDeleteCategory" class="secondary">Obriši kategoriju</button>
      </div>

      <p id="catMessage" class="small"></p>
    </div>

    <div class="panel">
      <h2>Podkategorije</h2>
      <div>
        <button id="btnListSubs">Učitaj listu podkategorija</button>
        <button id="btnCreateSub">Kreiraj novu podkategoriju</button>
      </div>

      <label>Lista podkategorija</label>
      <select id="subList" size="6"></select>

      <div id="subEditor" style="display:none; margin-top:12px;">
        <h3>Uredi podkategoriju</h3>
        <label>Naslov</label>
        <input type="text" id="sub_title">

        <div class="row">
          <div class="col"><label>CB1</label><input type="checkbox" id="sub_cb1"></div>
          <div class="col"><label>CB2</label><input type="checkbox" id="sub_cb2"></div>
          <div class="col"><label>CB3</label><input type="checkbox" id="sub_cb3"></div>
          <div class="col"><label>CB4</label><input type="checkbox" id="sub_cb4"></div>
        </div>

        <label>Dropdown</label>
        <select id="sub_dropdown">
          <option value="">-- izaberite --</option>
          <option value="opcija1">Opcija 1</option>
          <option value="opcija2">Opcija 2</option>
          <option value="opcija3">Opcija 3</option>
        </select>

        <label>Tekstovi</label>
        <input type="text" id="sub_text1" placeholder="Text 1">
        <input type="text" id="sub_text2" placeholder="Text 2">
        <input type="text" id="sub_text3" placeholder="Text 3">
        <input type="text" id="sub_text4" placeholder="Text 4">

        <div style="margin-top:10px;">
          <button id="btnUpdateSub">Ažuriraj podkategoriju</button>
          <button id="btnDeleteSub" class="secondary">Obriši podkategoriju</button>
        </div>
        <p id="subMessage" class="small"></p>
      </div>
    </div>
  </div>

<script>
const API_BASE = "https://botanica.ngrok.app";
const CLIENT_ID = "252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com";

let googleToken = null;
let selectedSubId = null;
const loginStatus = document.getElementById("loginStatus");
const catMessage = document.getElementById("catMessage");
const subMessage = document.getElementById("subMessage");

// Google One Tap callback
window.handleCredentialResponse = (response) => {
  if (response && response.credential) {
    googleToken = response.credential;
    loginStatus.textContent = "Ulogovani ste. Možete koristiti funkcionalnosti.";
  } else {
    loginStatus.textContent = "Prijava nije uspela.";
  }
};

// Helper: request with auth
async function authFetch(path, opts) {
  if (!googleToken) {
    throw new Error("Niste ulogovani (Google token nedostaje).");
  }
  opts = opts || {};
  opts.headers = opts.headers || {};
  opts.headers["Authorization"] = "Bearer " + googleToken;
  opts.headers["Content-Type"] = "application/json";
  const res = await fetch(API_BASE + path, opts);
  const data = await res.json().catch(()=>({}));
  if (!res.ok) throw {status: res.status, data};
  return data;
}

/* ---------- Category actions ---------- */
document.getElementById("btnLoadCategory").addEventListener("click", async ()=>{
  catMessage.textContent = "Učitavam...";
  try {
    const data = await authFetch("/category", { method: "GET" });
    if (!data.category) {
      catMessage.textContent = "Nema kategorije (kreirajte je).";
      // clear UI
      ["cat_cb1","cat_cb2","cat_cb3","cat_cb4"].forEach(id => document.getElementById(id).checked = false);
      document.getElementById("cat_dropdown").value = "";
      ["cat_text1","cat_text2","cat_text3","cat_text4"].forEach(id => document.getElementById(id).value = "");
      return;
    }
    const cat = data.category;
    document.getElementById("cat_cb1").checked = !!cat.cb1;
    document.getElementById("cat_cb2").checked = !!cat.cb2;
    document.getElementById("cat_cb3").checked = !!cat.cb3;
    document.getElementById("cat_cb4").checked = !!cat.cb4;
    document.getElementById("cat_dropdown").value = cat.dropdown || "";
    document.getElementById("cat_text1").value = cat.text1 || "";
    document.getElementById("cat_text2").value = cat.text2 || "";
    document.getElementById("cat_text3").value = cat.text3 || "";
    document.getElementById("cat_text4").value = cat.text4 || "";
    catMessage.textContent = "Kategorija učitana.";
  } catch (err) {
    console.error(err);
    catMessage.textContent = "Greška pri učitavanju kategorije.";
  }
});

document.getElementById("btnUpdateCategory").addEventListener("click", async ()=>{
  catMessage.textContent = "Šaljem...";
  const payload = {
    cb1: document.getElementById("cat_cb1").checked ? 1 : 0,
    cb2: document.getElementById("cat_cb2").checked ? 1 : 0,
    cb3: document.getElementById("cat_cb3").checked ? 1 : 0,
    cb4: document.getElementById("cat_cb4").checked ? 1 : 0,
    dropdown: document.getElementById("cat_dropdown").value,
    text1: document.getElementById("cat_text1").value,
    text2: document.getElementById("cat_text2").value,
    text3: document.getElementById("cat_text3").value,
    text4: document.getElementById("cat_text4").value
  };
  try {
    const data = await authFetch("/category", { method: "POST", body: JSON.stringify(payload) });
    catMessage.textContent = data.message || "Sačuvano.";
  } catch (err) {
    console.error(err);
    catMessage.textContent = "Greška pri čuvanju kategorije.";
  }
});

document.getElementById("btnDeleteCategory").addEventListener("click", async ()=>{
  if (!confirm("Obrisati kategoriju i sve podkategorije?")) return;
  catMessage.textContent = "Brišem...";
  try {
    const data = await authFetch("/category", { method: "DELETE" });
    catMessage.textContent = data.message || "Obrisano.";
    // clear UI
    ["cat_cb1","cat_cb2","cat_cb3","cat_cb4"].forEach(id => document.getElementById(id).checked = false);
    document.getElementById("cat_dropdown").value = "";
    ["cat_text1","cat_text2","cat_text3","cat_text4"].forEach(id => document.getElementById(id).value = "");
    // clear subs
    document.getElementById("subList").innerHTML = "";
    document.getElementById("subEditor").style.display = "none";
  } catch (err) {
    console.error(err);
    catMessage.textContent = "Greška pri brisanju kategorije.";
  }
});

/* ---------- Subcategory actions ---------- */
document.getElementById("btnListSubs").addEventListener("click", async ()=>{
  subMessage.textContent = "Učitavam...";
  try {
    const data = await authFetch("/subcategories", { method: "GET" });
    const list = document.getElementById("subList");
    list.innerHTML = "";
    (data.subcategories || []).forEach(s => {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = `${s.id} - ${s.title || "(no title)"}`;
      opt.dataset.raw = JSON.stringify(s);
      list.appendChild(opt);
    });
    subMessage.textContent = `Učitano ${data.subcategories.length} podkategorija.`;
  } catch (err) {
    console.error(err);
    subMessage.textContent = "Greška pri učitavanju podkategorija.";
  }
});

// select sub -> populate editor
document.getElementById("subList").addEventListener("change", function(){
  const opt = this.selectedOptions[0];
  if (!opt) return;
  const raw = JSON.parse(opt.dataset.raw || "{}");
  selectedSubId = parseInt(opt.value);
  document.getElementById("subEditor").style.display = "block";
  document.getElementById("sub_title").value = raw.title || "";
  document.getElementById("sub_cb1").checked = !!raw.cb1;
  document.getElementById("sub_cb2").checked = !!raw.cb2;
  document.getElementById("sub_cb3").checked = !!raw.cb3;
  document.getElementById("sub_cb4").checked = !!raw.cb4;
  document.getElementById("sub_dropdown").value = raw.dropdown || "";
  document.getElementById("sub_text1").value = raw.text1 || "";
  document.getElementById("sub_text2").value = raw.text2 || "";
  document.getElementById("sub_text3").value = raw.text3 || "";
  document.getElementById("sub_text4").value = raw.text4 || "";
  subMessage.textContent = "";
});

document.getElementById("btnCreateSub").addEventListener("click", async ()=>{
  const title = prompt("Naslov nove podkategorije (ostavi prazno za default):", "Nova podkategorija");
  if (title === null) return;
  const payload = { title: title || "" };
  subMessage.textContent = "Kreiram...";
  try {
    const data = await authFetch("/subcategory", { method: "POST", body: JSON.stringify(payload) });
    subMessage.textContent = `Kreirano (id=${data.id})`;
    // refresh list
    document.getElementById("btnListSubs").click();
  } catch (err) {
    console.error(err);
    subMessage.textContent = "Greška pri kreiranju.";
  }
});

document.getElementById("btnUpdateSub").addEventListener("click", async ()=>{
  if (!selectedSubId) { subMessage.textContent = "Nije odabrana podkategorija."; return; }
  const payload = {
    title: document.getElementById("sub_title").value || "",
    cb1: document.getElementById("sub_cb1").checked ? 1 : 0,
    cb2: document.getElementById("sub_cb2").checked ? 1 : 0,
    cb3: document.getElementById("sub_cb3").checked ? 1 : 0,
    cb4: document.getElementById("sub_cb4").checked ? 1 : 0,
    dropdown: document.getElementById("sub_dropdown").value,
    text1: document.getElementById("sub_text1").value,
    text2: document.getElementById("sub_text2").value,
    text3: document.getElementById("sub_text3").value,
    text4: document.getElementById("sub_text4").value
  };
  subMessage.textContent = "Ažuriram...";
  try {
    const data = await authFetch(`/subcategory/${selectedSubId}`, { method: "PUT", body: JSON.stringify(payload) });
    subMessage.textContent = data.message || "Sačuvano.";
    // refresh list
    document.getElementById("btnListSubs").click();
  } catch (err) {
    console.error(err);
    subMessage.textContent = "Greška pri ažuriranju podkategorije.";
  }
});

document.getElementById("btnDeleteSub").addEventListener("click", async ()=>{
  if (!selectedSubId) { subMessage.textContent = "Nije odabrana podkategorija."; return; }
  if (!confirm("Obrisati ovu podkategoriju?")) return;
  subMessage.textContent = "Brišem...";
  try {
    const data = await authFetch(`/subcategory/${selectedSubId}`, { method: "DELETE" });
    subMessage.textContent = data.message || "Obrisano.";
    selectedSubId = null;
    document.getElementById("subEditor").style.display = "none";
    document.getElementById("btnListSubs").click();
  } catch (err) {
    console.error(err);
    subMessage.textContent = "Greška pri brisanju podkategorije.";
  }
});
</script>
</body>
</html>
