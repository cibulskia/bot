<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Category Manager (Demo)</title>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f6f7fb; color:#111; }
  .box { background:white; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:16px; }
  h2 { margin-top:0; }
  label { display:block; margin:6px 0; }
  input[type="text"] { width:100%; padding:8px; border-radius:6px; border:1px solid #ddd; }
  input[disabled] { background:#eee; }
  button { padding:10px 14px; border-radius:8px; border:none; background:#0b76ff; color:white; cursor:pointer; margin-right:8px; }
  button.danger { background:#d9534f; }
  button.secondary { background:#6c757d; }
  .row { display:flex; gap:12px; }
  .col { flex:1; }
  .status { margin-top:8px; color:#333; }
  .subcat-list { max-height:160px; overflow:auto; border:1px solid #eee; padding:8px; border-radius:6px; background:#fafafa; }
  .subcat-item { padding:6px; cursor:pointer; border-bottom:1px dashed #eee; }
  .subcat-item:hover { background:#f0f8ff; }
</style>
</head>
<body>
<div id="g_id_onload" data-client_id="252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com" data-callback="handleCredentialResponse" data-auto_select="true" data-ux_mode="popup"></div>

<div class="box">
  <h2>Prijava</h2>
  <p id="loginStatus">Čekam Google prijavu...</p>
  <button id="signOutBtn" style="display:none" class="secondary">Odjavi se</button>
</div>

<div class="box">
  <h2>Kategorija (glavni deo)</h2>
  <div class="row">
    <div class="col">
      <label><input type="checkbox" id="cat_cb1"> proizvodjac</label>
      <label><input type="checkbox" id="cat_cb2"> poslodavac</label>
    </div>
    <div class="col">
      <label>Dropdown:
        <select id="cat_dropdown">
          <option value="">-- izaberi --</option>
          <option value="opt1">strug</option>
          <option value="opt2">glodalica</option>
          <option value="opt3">strug i glodalica</option>
        </select>
      </label>

      <label>ime firme: <input type="text" id="cat_text1" placeholder="Unesite ime firme"></label>
      <label>opis firme: <input type="text" id="cat_text2" placeholder="Unesite opis firme"></label>
      <label>email: <input type="text" id="cat_text3" placeholder="Unesite email"></label>
      <label>internet stranica: <input type="text" id="cat_text4" placeholder="Unesite internet stranicu"></label>
    </div>
  </div>

  <div style="margin-top:12px;">
    <button id="btnLoadCategory">Učitaj kategoriju</button>
    <button id="btnUpdateCategory">Sačuvaj / Ažuriraj kategoriju</button>
    <button id="btnDeleteCategory" class="danger">Obriši sve iz kategorije</button>
  </div>
  <div class="status" id="catStatus"></div>
</div>

<div class="box">
  <h2>Podkategorije</h2>
  <div class="row">
    <div style="width:280px;">
      <div style="display:flex; gap:8px; margin-bottom:8px;">
        <button id="btnListSubcats">Lista podkategorija</button>
      </div>
      <div class="subcat-list" id="subcatList"></div>
    </div>

    <div style="flex:1;">
      <h3 id="subcatEditorTitle">Nije izabrana podkategorija</h3>
      
      <label>Ime podkategorije: <input type="text" id="sub_name" disabled></label>
      <label><input type="checkbox" id="sub_cb1"> konkurisi</label>
      <label>CB2: <input type="checkbox" id="sub_cb2" disabled></label>
      <label>kratak opis: <input type="text" id="sub_text1" disabled></label>
      <label>objasnjenje: <input type="text" id="sub_text2" disabled></label>
      <label>dodatak 1: <input type="text" id="sub_text3" disabled></label>
      <label>dodatak 2: <input type="text" id="sub_text4" disabled></label>

      <div style="margin-top:8px;">
        <button id="btnUpdateSubcat">Ažuriraj podkategoriju</button>
      </div>
      <div class="status" id="subStatus"></div>
    </div>
  </div>
</div>

<script>
const CLIENT_ID = "252373158568-4up41b7jo8ik6cu8c1pl3mlvvck2sq2t.apps.googleusercontent.com";
const API_BASE = "https://botanica.ngrok.app";
let googleToken = null;
let selectedSubcatId = null;

window.handleCredentialResponse = (response) => {
  if (response && response.credential) {
    googleToken = response.credential;
    document.getElementById("loginStatus").textContent = "Ulogovan (token primljen).";
    document.getElementById("signOutBtn").style.display = "inline-block";
  } else {
    document.getElementById("loginStatus").textContent = "Prijava nije uspela.";
  }
};

document.getElementById("signOutBtn").addEventListener("click", () => {
  googleToken = null;
  document.getElementById("loginStatus").textContent = "Odjavljeno.";
  document.getElementById("signOutBtn").style.display = "none";
});

async function apiFetch(path, method="GET", body=null) {
  if (!googleToken) throw new Error("No Google token. Please sign in.");
  const headers = {
    "Authorization": `Bearer ${googleToken}`,
    "Content-Type": "application/json"
  };
  const res = await fetch(API_BASE + path, { method, headers, body: body ? JSON.stringify(body) : undefined });
  const txt = await res.text();
  try { return { ok: res.ok, status: res.status, json: JSON.parse(txt) }; }
  catch (e) { return { ok: res.ok, status: res.status, json: { raw: txt } }; }
}

// Category
document.getElementById("btnLoadCategory").addEventListener("click", async () => {
  const status = document.getElementById("catStatus");
  status.textContent = "Učitavanje...";
  try {
    const r = await apiFetch("/category/load", "GET");
    if (!r.ok) throw r.json;
    const data = r.json;
    setCategoryFields(data.category || {checkboxes:[false,false], dropdown:"", texts:["","","",""]});
    const scList = document.getElementById("subcatList");
    scList.innerHTML = "";
    (data.subcategories || []).forEach(s => {
      const div = document.createElement("div");
      div.className = "subcat-item";
      div.textContent = `${s.id} — ${s.name || "(bez imena)"}`;
      div.dataset.id = s.id;
      div.addEventListener("click", () => loadSubcatForEdit(s.id));
      scList.appendChild(div);
    });
    status.textContent = "Kategorija učitana.";
  } catch (e) { console.error(e); status.textContent = "Greška pri učitavanju kategorije."; }
});

document.getElementById("btnUpdateCategory").addEventListener("click", async () => {
  const status = document.getElementById("catStatus");
  status.textContent = "Šaljem...";
  try {
    const r = await apiFetch("/category/update", "POST", getCategoryFields());
    status.textContent = r.ok ? (r.json.message || "Sačuvano.") : "Greška: " + JSON.stringify(r.json);
  } catch (e) { console.error(e); status.textContent = "Greška pri slanju."; }
});

document.getElementById("btnDeleteCategory").addEventListener("click", async () => {
  if (!confirm("Da li stvarno želite da obrišete sve iz kategorije (uključujući podkategorije)?")) return;
  const status = document.getElementById("catStatus");
  status.textContent = "Brišem...";
  try {
    const r = await apiFetch("/category/delete_all", "POST", {});
    status.textContent = r.ok ? (r.json.message || "Obrisano.") : "Greška: " + JSON.stringify(r.json);
    setCategoryFields({checkboxes:[false,false], dropdown:"", texts:["","","",""]});
    document.getElementById("subcatList").innerHTML = "";
  } catch (e) { console.error(e); status.textContent = "Greška pri brisanju kategorije."; }
});

// Subcategories
document.getElementById("btnListSubcats").addEventListener("click", async () => {
  const status = document.getElementById("subStatus");
  status.textContent = "Učitavam listu...";
  try {
    const r = await apiFetch("/subcategories/list", "GET");
    const list = r.json.subcategories || [];
    const scList = document.getElementById("subcatList");
    scList.innerHTML = "";
    list.forEach(s => {
      const div = document.createElement("div");
      div.className = "subcat-item";
      div.textContent = `${s.id} — ${s.name || "(bez imena)"}`;
      div.dataset.id = s.id;
      div.addEventListener("click", () => loadSubcatForEdit(s.id));
      scList.appendChild(div);
    });
    status.textContent = `Pronađeno ${list.length} podkategorija.`;
  } catch (e) { console.error(e); status.textContent = "Greška pri listanju podkategorija."; }
});

async function loadSubcatForEdit(id) {
  const status = document.getElementById("subStatus");
  status.textContent = "Učitavam podkategoriju...";
  try {
    const r = await apiFetch("/subcategory/" + id, "GET");
    const s = r.json.subcategory;
    selectedSubcatId = s.id;
    document.getElementById("subcatEditorTitle").textContent = `Edit podkategorije: ${s.id}`;
    
    document.getElementById("sub_name").value = s.name || "";
    document.getElementById("sub_cb1").checked = !!(s.checkboxes && s.checkboxes[0]);
    document.getElementById("sub_cb2").checked = !!(s.checkboxes && s.checkboxes[1]);
    document.getElementById("sub_text1").value = (s.texts && s.texts[0]) || "";
    document.getElementById("sub_text2").value = (s.texts && s.texts[1]) || "";
    document.getElementById("sub_text3").value = (s.texts && s.texts[2]) || "";
    document.getElementById("sub_text4").value = (s.texts && s.texts[3]) || "";
    
    status.textContent = "Podkategorija učitana.";
  } catch (e) { console.error(e); status.textContent = "Greška pri učitavanju podkategorije."; }
}

document.getElementById("btnUpdateSubcat").addEventListener("click", async () => {
  if (!selectedSubcatId) { alert("Nije izabrana podkategorija."); return; }
  const status = document.getElementById("subStatus");
  status.textContent = "Ažuriram...";
  try {
    const payload = { checkboxes: [document.getElementById("sub_cb1").checked] };
    const r = await apiFetch("/subcategory/update/" + selectedSubcatId, "POST", payload);
    status.textContent = r.ok ? (r.json.message || "Ažurirano.") : "Greška: " + JSON.stringify(r.json);
  } catch (e) { console.error(e); status.textContent = "Greška pri ažuriranju."; }
};

// helpers for category
function getCategoryFields() {
  return {
    checkboxes: [document.getElementById("cat_cb1").checked, document.getElementById("cat_cb2").checked],
    dropdown: document.getElementById("cat_dropdown").value,
    texts: [document.getElementById("cat_text1").value, document.getElementById("cat_text2").value,
            document.getElementById("cat_text3").value, document.getElementById("cat_text4").value]
  };
}

function setCategoryFields(obj) {
  const cb = obj.checkboxes || [false,false];
  document.getElementById("cat_cb1").checked = !!cb[0];
  document.getElementById("cat_cb2").checked = !!cb[1];
  document.getElementById("cat_dropdown").value = obj.dropdown || "";
  const texts = obj.texts || ["","","",""];
  document.getElementById("cat_text1").value = texts[0] || "";
  document.getElementById("cat_text2").value = texts[1] || "";
  document.getElementById("cat_text3").value = texts[2] || "";
  document.getElementById("cat_text4").value = texts[3] || "";
}
</script>
</body>
</html>
