<!DOCTYPE html>
<html>
<head>
    <title>Test Stranica sa Sesijom</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <button id="testButton">Pritisni Me</button>
    <p id="response"></p>

    <script>
        let MY_SECRET_CLIENT_TOKEN = null;

        // Dohvati token sa servera
        function fetchToken(callback) {
            $.ajax({
                url: "https://botanica.ngrok.app/get_token",
                type: "GET",
                xhrFields: { withCredentials: true }, // šalje kolačiće
                success: function(data){
                    MY_SECRET_CLIENT_TOKEN = data.token;
                    console.log("Token primljen:", MY_SECRET_CLIENT_TOKEN);
                    if (callback) callback();
                },
                error: function(){
                    console.log("Ne mogu da dohvatim token sa servera.");
                }
            });
        }

        $(document).ready(function(){
            // Prvo dohvatimo token
            fetchToken();

            $('#testButton').click(function(){
                if (!MY_SECRET_CLIENT_TOKEN) {
                    $('#response').text("Token još nije primljen. Pokušaj ponovo.");
                    return;
                }

                $.ajax({
                    url: 'https://botanica.ngrok.app/button_press',
                    type: 'POST',
                    contentType: 'application/json',
                    headers: {
                        'X-My-Secret-Token': MY_SECRET_CLIENT_TOKEN
                    },
                    xhrFields: { withCredentials: true }, // šalje kolačiće
                    success: function(response){
                        $('#response').text(response.message);
                    },
                    error: function(jqXHR){
                        console.log("Greška:", jqXHR.status, jqXHR.responseText);
                        $('#response').text("Došlo je do greške. Proveri konzolu.");
                        // Ako je token istekao, osveži token i pokušaj ponovo
                        if (jqXHR.status === 403) {
                            fetchToken(function(){
                                console.log("Novi token primljen, pokušaj ponovo.");
                            });
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
