<!DOCTYPE html>
<html lang="sr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chat Widget</title>
</head>
<body>

<!-- Chat Widget Start -->
<style>
    #qaPopup {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 100%;
        max-width: 400px;
        border-radius: 10px;
        background: #f9f9f9;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        border: 1px solid #ccc;
        display: none;
        flex-direction: column;
        z-index: 1006;
        overflow: hidden;
    }
    #chatHistory {
        padding: 10px;
        max-height: 50vh;
        overflow-y: auto;
        font-size: 0.95em;
    }
    .chat-message { margin-bottom: 10px; word-wrap: break-word; }
    .chat-message.user { text-align: right; color: #007BFF; }
    .chat-message.bot { text-align: left; color: #333333; }

    #qaPopup textarea { 
        padding:10px; 
        width: calc(100% - 20px); 
        font-size:1em; 
        margin:10px; 
        display:block; 
        resize:none;
        min-height:40px;  
        overflow:hidden;
        box-sizing:border-box;
    }
    #qaPopup button { 
        padding:10px 15px; 
        font-size:1em; 
        cursor:pointer; 
        margin:10px; 
        align-self:flex-end;
    }

    #openChatBtn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1005;
        padding: 15px 25px;
        font-size: 1.2em;
        cursor: pointer;
        border-radius: 50px;
        border: none;
        background-color: #888;
        color: white;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    #openChatBtn:hover { background-color: #007BFF; }
</style>

<button id="openChatBtn">Chat</button>
<div id="qaPopup">
    <div id="chatHistory"></div>
    <textarea id="userQuestion" placeholder="Postavi pitanje..."></textarea>
    <button id="sendBtn">Pošalji</button>
</div>

<script>
    const SERVER_URL = "https://botanica.ngrok.app"; // Tvoj ngrok URL
    const openChatBtn = document.getElementById("openChatBtn");
    const qaPopup = document.getElementById("qaPopup");
    const sendBtn = document.getElementById("sendBtn");
    const userQuestion = document.getElementById("userQuestion");
    const chatHistory = document.getElementById("chatHistory");

    let visitorId = localStorage.getItem("visitor_id");
    if (!visitorId) {
        visitorId = "user_" + Math.random().toString(36).substring(2, 10);
        localStorage.setItem("visitor_id", visitorId);
    }

    let loadingInterval = null;
    let pollingInterval = null;

    function startLoading() {
        let dots = 0;
        loadingInterval = setInterval(() => {
            dots = (dots + 1) % 4;
            userQuestion.placeholder = "Obrada" + ".".repeat(dots);
        }, 500);
    }

    function stopLoading() {
        clearInterval(loadingInterval);
        loadingInterval = null;
        userQuestion.placeholder = "Postavi pitanje...";
    }

    function appendMessage(sender, text) {
        const div = document.createElement("div");
        div.className = `chat-message ${sender}`;
        div.textContent = text;
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    userQuestion.addEventListener('input', e => {
        e.target.style.height = 'auto';
        e.target.style.height = (e.target.scrollHeight) + 'px';
    });

    async function sendQuestion() {
        const question = userQuestion.value.trim();
        if(!question) return;
        appendMessage("user", question);
        userQuestion.value = '';
        userQuestion.style.height = 'auto';
        startLoading();

        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${SERVER_URL}/ask?id=${encodeURIComponent(visitorId)}&question=${encodeURIComponent(question)}&_t=${timestamp}`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            });
            const data = await response.json();
            if (!response.ok) {
                appendMessage("bot", `Greška prilikom slanja pitanja: ${data.message || 'Nepoznata greška'}`);
                stopLoading();
            }
        } catch (err) {
            appendMessage("bot", "Greška u komunikaciji sa serverom.");
            stopLoading();
        }
    }

    async function pollForAnswer() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${SERVER_URL}/check_answer?id=${encodeURIComponent(visitorId)}&_t=${timestamp}`, {
                headers: { "ngrok-skip-browser-warning": "true" }
            });
            const data = await response.json();
            if (response.ok && data.status === "success") {
                stopLoading();
                appendMessage("bot", data.answer);
            }
        } catch (err) {
            console.error("Polling greška:", err);
        }
    }

    function startPolling() {
        if (!pollingInterval) {
            pollingInterval = setInterval(pollForAnswer, 2000);
        }
    }

    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
    }

    openChatBtn.addEventListener("click", () => {
        qaPopup.style.display = qaPopup.style.display === "flex" ? "none" : "flex";
        if (qaPopup.style.display === "flex") startPolling();
        else stopPolling();
    });

    sendBtn.addEventListener("click", sendQuestion);
    userQuestion.addEventListener("keydown", e => {
        if(e.key === "Enter" && !e.shiftKey){
            e.preventDefault();
            sendQuestion();
        }
    });
</script>
<!-- Chat Widget End -->

</body>
</html>
