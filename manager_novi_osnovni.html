<!DOCTYPE html>
<html>
<head>
    <title>GitHub Hosted App</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .input-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-right: 0;
        }
        .input-group {
            box-sizing: border-box;
            width: calc((100% - (5 * 15px)) / 6);
            margin-bottom: 15px;
        }
        
        .input-group input[type="text"] {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 20px;
            margin-right: 10px; /* Dodato malo razmaka između dugmadi */
        }
        button:hover:not(:disabled) {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #responseArea {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            background-color: #e9e9e9;
            border-radius: 4px;
            white-space: pre-wrap; /* Omogućava prelamanje teksta */
        }
        #googleLoginButton {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="inputFieldsContainer" class="input-grid"></div>
    <button id="submitButton" disabled>Pošalji</button>
    <button id="logoutButton" style="display: none;">Odjavi se</button>
    <button id="showChatWidgetCodeButton">Prikaži Chat Widget Kod</button> <!-- Novo dugme -->
    <div id="googleLoginButton"></div>
    <div id="responseArea"></div>

    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <script>
        const submitButton = document.getElementById('submitButton');
        const logoutButton = document.getElementById('logoutButton');
        const googleLoginButton = document.getElementById('googleLoginButton');
        const responseArea = document.getElementById('responseArea');
        const inputFieldsContainer = document.getElementById('inputFieldsContainer');
        const showChatWidgetCodeButton = document.getElementById('showChatWidgetCodeButton'); // Referenca na novo dugme

        const numberOfFields = 47;
        let inputFields = [];
        let authToken = null; 

        function setAuthToken(token) {
            authToken = token;
            localStorage.setItem('authToken', token);
        }

        function getAuthToken() {
            if (authToken) return authToken;
            return localStorage.getItem('authToken');
        }

        function clearAuthToken() {
            authToken = null;
            localStorage.removeItem('authToken');
            submitButton.disabled = true;
            googleLoginButton.style.display = 'block';
            logoutButton.style.display = 'none';
            responseArea.innerText = "Molimo prijavite se putem Google-a da biste slali podatke.";
        }

        submitButton.disabled = true;
        responseArea.innerText = "Molimo prijavite se putem Google-a da biste slali podatke.";
        logoutButton.style.display = 'none';

        for (let i = 0; i < numberOfFields; i++) {
            const div = document.createElement('div');
            div.classList.add('input-group');
            const input = document.createElement('input');
            input.type = 'text';
            input.id = `inputField_${i}`;
            input.placeholder = `Unesite tekst za polje ${i + 1}`;
            div.appendChild(input);
            inputFieldsContainer.appendChild(div);
            inputFields.push(input);
        }

        function handleCredentialResponse(response) {
            fetch('https://botanica.ngrok.app/oauth_callback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ credential: response.credential })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.token) {
                    setAuthToken(data.token);
                    responseArea.innerText = `Google prijava: Dobrodošli, ${data.user_name} (${data.user_email}). Sada možete slati podatke.`;
                    submitButton.disabled = false;
                    googleLoginButton.style.display = 'none';
                    logoutButton.style.display = 'block';
                } else {
                    responseArea.innerText = 'Greška pri Google prijavi: ' + data.message;
                    submitButton.disabled = true;
                    googleLoginButton.style.display = 'block';
                    logoutButton.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Greška pri Google prijavi:', error);
                responseArea.innerText = 'Greška pri Google prijavi.';
                submitButton.disabled = true;
                googleLoginButton.style.display = 'block';
                logoutButton.style.display = 'none';
            });
        }

        window.onload = function () {
            google.accounts.id.initialize({
                client_id: "748161753679-207vasmi8poi0lc0gqvmqv9fphrv6op1.apps.googleusercontent.com",
                callback: handleCredentialResponse
            });
            google.accounts.id.renderButton(
                document.getElementById("googleLoginButton"),
                { theme: "outline", size: "large" }
            );
            const storedToken = getAuthToken();
            if (storedToken) {
                authToken = storedToken;
                submitButton.disabled = false;
                googleLoginButton.style.display = 'none';
                logoutButton.style.display = 'block';
                responseArea.innerText = "Nastavak sesije. Možete slati podatke.";
            } else {
                google.accounts.id.prompt();
            }
        };

        submitButton.addEventListener('click', () => {
            const token = getAuthToken();
            if (!token) {
                responseArea.innerText = "Morate biti prijavljeni da biste slali podatke!";
                return;
            }

            const allData = inputFields.map(field => field.value);
            
            const dataToSend = {
                fields_data: allData
            };

            fetch('https://botanica.ngrok.app/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(dataToSend)
            })
            .then(response => {
                if (response.status === 401) {
                    clearAuthToken();
                    responseArea.innerText = "Vaša sesija je istekla ili je nevažeća. Molimo prijavite se ponovo.";
                    return response.json();
                }
                return response.json();
            })
            .then(result => {
                if (result) {
                    if (result.status === 'success') {
                        responseArea.innerText = 'Odgovor servera: Podaci uspešno primljeni i sačuvani!';
                    } else {
                        responseArea.innerText = 'Greška servera: ' + result.message;
                    }
                }
            })
            .catch(error => {
                console.error('Greška pri slanju:', error);
                responseArea.innerText = 'Greška pri slanju podataka.';
            });
        });

        logoutButton.addEventListener('click', () => {
            google.accounts.id.disableAutoSelect();
            clearAuthToken();
        });

        // Event listener za novo dugme "Prikaži Chat Widget Kod"
        showChatWidgetCodeButton.addEventListener('click', () => {
            const field47Value = inputFields[46].value; // Polje 47 je na indeksu 46
            const chatWidgetCode = `<iframe 
  src="https://cibulskia.github.io/bot/chat_widget?site=${field47Value}"  
  style="position: fixed; bottom: 0; right: 0; width: 100%; max-width: 400px; height: 600px; border: none; z-index: 9999;"
  scrolling="no"
></iframe>`;
            responseArea.innerText = chatWidgetCode;
        });
    </script>
</body>
</html>
